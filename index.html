<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光影織藝專業估價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 內建圖示元件 (解決外部連結 404 問題) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Scissors: <Icon path={<><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></>} />,
            Ruler: <Icon path={<><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><line x1="14.5" y1="12.5" x2="18.5" y2="8.5"/><line x1="11.5" y1="15.5" x2="15.5" y2="11.5"/><line x1="8.5" y1="18.5" x2="12.5" y2="14.5"/></>} />,
            Settings: <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            DollarSign: <Icon path={<><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>} />,
            RefreshCw: <Icon path={<><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>} />,
            ShoppingCart: <Icon path={<><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></>} />,
            Trash2: <Icon path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Plus: <Icon path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            ArrowLeft: <Icon path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            FileText: <Icon path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
            Edit2: <Icon path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />,
            Tag: <Icon path={<><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>} />,
            Printer: <Icon path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />
        };

        const Checkbox = ({ label, checked, onChange, isRadio = false }) => (
            <label className={`flex items-center gap-3 cursor-pointer p-3 rounded-lg border transition-all ${checked ? 'bg-blue-50 border-blue-400 text-blue-700 shadow-sm' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}>
                <div className={`w-5 h-5 flex items-center justify-center border rounded ${checked ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'} ${isRadio ? 'rounded-full' : ''}`}>
                {checked && <div className={`bg-white ${isRadio ? 'w-2.5 h-2.5 rounded-full' : 'w-3 h-3 rounded-sm'}`} />}
                </div>
                <span className="text-sm font-bold">{label}</span>
                <input type="checkbox" className="hidden" checked={checked} onChange={onChange} />
            </label>
        );

        const CurtainCalculator = () => {
            const [activeTab, setActiveTab] = useState('pleat'); 
            const [currentView, setCurrentView] = useState('calculator'); 

            const [width, setWidth] = useState(180); 
            const [height, setHeight] = useState(256); 
            const [price, setPrice] = useState(240); 
            const [multiplier, setMultiplier] = useState(2.2); 
            const [note, setNote] = useState(''); 
            const [model, setModel] = useState(''); 
            
            const [hookSpacing, setHookSpacing] = useState(8); 
            
            const [mountType, setMountType] = useState('');
            const [openType, setOpenType] = useState('double');
            const [trackOp, setTrackOp] = useState('');
            const [hasArm, setHasArm] = useState(false);

            const [caiSpecs, setCaiSpecs] = useState({
                pullLeft: false, pullRight: false,
                openSingle: false, openDouble: false,
                stackLeft: false, stackRight: false
            });

            const [fabricType, setFabricType] = useState('厚布');
            const [trackType, setTrackType] = useState('M16金屬勾軌道');
            const [shapeMemory, setShapeMemory] = useState(false);
            const [stainlessHook, setStainlessHook] = useState(false);
            const [tieBack, setTieBack] = useState(false);
            const [leadWeight, setLeadWeight] = useState(false);
            
            const [cart, setCart] = useState([]);

            const [result, setResult] = useState({
                fabricWidthChi: 0, fabricWidthYard: 0, fabricCuts: 0,
                totalFabricCost: 0, sewingCost: 0, trackCost: 0,
                shapeMemoryCost: 0, hookCost: 0, tieBackCost: 0, leadCost: 0,
                totalAmount: 0, debugInfo: "",
            });

            // 為避免字串換行錯誤，將長字串分開寫
            const TRACK_PRICES = {
                '無': 0, '九龍軟軌': 70, 'M16金屬勾軌道': 66, 'S軌免鎖天架': 54, '新鋁小': 46
            };
            const SNAKE_TRACK_PRICES = {
                '無': 0, '九龍軟軌': 120, 'M16金屬勾軌道': 100, 'S軌免鎖天架': 100, '新鋁小': 80
            };
            const SNAKE_SEWING_PRICES = { '一般': 80, '厚布': 90, '絨布、麂皮布': 100 };
            const SEWING_PRICES = {
                '一般': { perCut: 110, perChi: 60, perYard: 80 }, 
                '厚布': { perCut: 130, perChi: 70, perYard: 90 },
                '絨布、麂皮布': { perCut: 150, perChi: 80, perYard: 100 },
            };
            const TAB_LABELS = {
                'pleat': '三折簾 (一般)',
                'seamless': '三折簾 (無接縫)',
                'snake': '蛇行簾',
                'cai': '才數計價'
            };

            useEffect(() => {
                calculate();
            }, [width, height, price, multiplier, hookSpacing, openType, fabricType, trackType, shapeMemory, stainlessHook, tieBack, leadWeight, activeTab]);

            const calculate = () => {
                let res = { ...result };
                const widthChi = Math.round((width / 30) * 10) / 10;
                const heightChi = Math.round((height / 30) * 10) / 10;

                if (activeTab === 'pleat') {
                    res.fabricCuts = Math.ceil((width / 150) * multiplier);
                    const actualFabricWidthChi = Math.round((widthChi * multiplier) * 10) / 10;
                    const totalLenChi = res.fabricCuts * heightChi;
                    
                    res.fabricWidthChi = totalLenChi;
                    res.fabricWidthYard = Math.round((totalLenChi / 3) * 10) / 10; 
                    res.totalFabricCost = Math.ceil(res.fabricCuts * heightChi * price);
                    res.sewingCost = res.fabricCuts * SEWING_PRICES[fabricType].perCut;
                    res.trackCost = Math.ceil(widthChi * TRACK_PRICES[trackType]);
                    res.hookCost = stainlessHook ? (res.fabricCuts * 20) : 0; 
                    res.leadCost = leadWeight ? Math.ceil(actualFabricWidthChi * 40) : 0; 

                } else if (activeTab === 'seamless' || activeTab === 'snake') {
                    let actualFabricWidthChi = 0; 
                    let actualFabricWidthYard = 0;
                    let actualWidthCm = 0; 

                    if (activeTab === 'snake') {
                        const halfWidth = width / 2;
                        let runners = 0;
                        if (openType === 'double') {
                            const rawSideRunners = Math.round((halfWidth * multiplier) / hookSpacing);
                            const sideRunners = rawSideRunners % 2 === 0 ? rawSideRunners : rawSideRunners + 1;
                            runners = sideRunners * 2;
                            res.debugInfo = `雙開: 單邊${sideRunners}顆 (共${runners}顆)`;
                        } else {
                            const rawRunners = Math.round((width * multiplier) / hookSpacing);
                            runners = rawRunners % 2 === 0 ? rawRunners : rawRunners + 1;
                            res.debugInfo = `單開: ${runners}顆`;
                        }
                        actualWidthCm = (runners - 1) * hookSpacing;
                    } else {
                        actualWidthCm = width * multiplier;
                        res.debugInfo = "無接縫平攤計算";
                    }

                    actualFabricWidthChi = Math.round((actualWidthCm / 30) * 10) / 10;
                    actualFabricWidthYard = Math.round((actualWidthCm / 90) * 10) / 10;
                    res.fabricWidthChi = actualFabricWidthChi;
                    res.fabricWidthYard = actualFabricWidthYard;
                    res.fabricCuts = Math.ceil(actualWidthCm / 150);
                    res.totalFabricCost = Math.ceil(actualFabricWidthChi * price);

                    if (activeTab === 'snake') {
                        res.sewingCost = Math.ceil(actualFabricWidthChi * SNAKE_SEWING_PRICES[fabricType]);
                    } else {
                        res.sewingCost = Math.ceil(actualFabricWidthChi * SEWING_PRICES[fabricType].perChi);
                    }
                    
                    const trackUnitPrice = activeTab === 'snake' ? SNAKE_TRACK_PRICES[trackType] : TRACK_PRICES[trackType];
                    res.trackCost = Math.ceil(widthChi * trackUnitPrice);
                    res.hookCost = stainlessHook ? (Math.ceil(actualFabricWidthChi * 10)) : 0;
                    res.leadCost = leadWeight ? (Math.ceil(actualFabricWidthChi * 40)) : 0;
                } 
                else if (activeTab === 'cai') {
                    const cai = Math.ceil((width * height) / 900);
                    res.fabricCuts = cai; 
                    res.totalFabricCost = cai * price;
                    res.sewingCost = 0; res.trackCost = 0; res.shapeMemoryCost = 0; res.hookCost = 0; res.leadCost = 0;
                }

                if (activeTab === 'cai') {
                    res.shapeMemoryCost = 0;
                } else {
                    res.shapeMemoryCost = shapeMemory ? (res.fabricCuts < 6.25 ? 900 : Math.ceil(res.fabricCuts * 160)) : 0;
                }

                res.tieBackCost = tieBack ? 120 : 0;
                res.totalAmount = res.totalFabricCost + res.sewingCost + res.trackCost + res.shapeMemoryCost + res.hookCost + res.tieBackCost + res.leadCost;

                setResult(res);
            };

            const getSpecString = () => {
                let specs = [];
                if (mountType === 'ceiling') specs.push('天架');
                if (mountType === 'wall') specs.push('壁架');
                if (activeTab !== 'cai') {
                    specs.push(openType === 'double' ? '雙開' : '單開');
                    if (trackOp === 'hand') specs.push('手撥軌');
                    if (trackOp === 'art') specs.push('藝術軌');
                    if (trackOp === 'cord') specs.push('拉繩軌');
                    if (hasArm) specs.push('左右臂');
                    if (shapeMemory) specs.push('定型');
                    if (stainlessHook) specs.push('白鐵勾');
                    if (tieBack) specs.push('綁帶');
                    if (leadWeight) specs.push('鉛條');
                } else {
                    if (caiSpecs.pullLeft) specs.push('左拉');
                    if (caiSpecs.pullRight) specs.push('右拉');
                    if (caiSpecs.openSingle) specs.push('單開');
                    if (caiSpecs.openDouble) specs.push('雙開');
                    if (caiSpecs.stackLeft) specs.push('收左');
                    if (caiSpecs.stackRight) specs.push('收右');
                }
                return specs;
            };

            const addToCart = () => {
                const newItem = {
                id: Date.now(),
                note: note || `窗簾 ${cart.length + 1}`,
                model: model || '-',
                typeLabel: TAB_LABELS[activeTab],
                dimensions: `寬：${width}CM 高：${height}CM`,
                specList: getSpecString(),
                details: { ...result },
                rawInput: { width, height, price, multiplier }
                };
                setCart([...cart, newItem]);
                setNote('');
                setModel('');
                setMountType('');
                setTrackOp('');
                setHasArm(false);
                setCaiSpecs({ pullLeft: false, pullRight: false, openSingle: false, openDouble: false, stackLeft: false, stackRight: false });
                alert(`已加入購物車：${newItem.note}`);
            };

            const removeFromCart = (index) => {
                const newCart = [...cart];
                newCart.splice(index, 1);
                setCart(newCart);
            };

            const updateCartItemNote = (index, newNote) => {
                const newCart = [...cart];
                newCart[index].note = newNote;
                setCart(newCart);
            };

            const updateCartItemModel = (index, newModel) => {
                const newCart = [...cart];
                newCart[index].model = newModel;
                setCart(newCart);
            };

            const grandTotal = cart.reduce((sum, item) => sum + item.details.totalAmount, 0);

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="max-w-6xl mx-auto p-4 bg-gray-50 min-h-screen font-sans text-gray-800 print:bg-white print:p-0 print:max-w-none">
                
                {/* Header */}
                <div className="bg-white p-6 rounded-xl shadow-sm mb-6 border-l-4 border-blue-600 flex justify-between items-center sticky top-0 z-50 no-print">
                    <div>
                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        {/* LOGO */}
                        <img 
                        src="光影織藝橫式ＬＯＧＯ.png" 
                        alt="光影織藝 Logo" 
                        className="h-10 w-auto object-contain" 
                        onError={(e) => {
                            e.target.style.display = 'none';
